---
title: "Regras de associação para produtos (codificação em R)"
author: "Gleynner Ghiotto"
output:
  html_document:
    df_print: paged
    number_sections: true
    toc: true
#    toc_float: true
    toc_depth: 3
    theme: readable
    highlight: pygments
editor_options: 
  chunk_output_type: inline
---

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = TRUE,comment="",warning = FALSE,message = FALSE)
```

```{r, include=FALSE}
# Listar pacotes que serão utilizados:
r_pkgs <- c("tidyverse", "RODBC","kableExtra", "knitr","ggcorrplot","cowplot","patchwork",
            "reshape2","arules","DBI","odbc","dbplyr")

# Instala o pacote pacman se ele não estiver instalado:
if(!"pacman" %in% rownames(installed.packages())) install.packages("pacman")

# Carrega os pacotes listados:
pacman::p_load(char = r_pkgs)
```

```{r, include=FALSE}
# Função para retornar informações relevantes do dataframe
my_summary<-function(df){
  return(
    data.frame("Variavel"=df %>% names(), 
               "Tipo"=df %>% summarise_all(typeof) %>%gather() %>% select(value) %>% pull(),
               "N"=df %>% summarise_all(list( n = ~ n()))%>%gather() %>% select(value) %>% pull(),
               "Missing"=df %>%map_df(function(x) sum(is.na(x))) %>%gather() %>% select(value) %>% pull(),
               "Missing_Percent"=df %>%map_df(function(x) sum(is.na(x))/length(x)*100) %>%gather() %>% select(value) %>% pull() %>% round(1),
               "N_unique"=df %>%map_df(function(x) length(unique(x))) %>%gather() %>% select(value) %>% pull()
    )
  )
}

# Função para exibir tabelas
printTabela <- function(df){
  kable(df) %>% kable_styling(htmltable_class = "lightable-classic") %>%
    row_spec(0, bold = T, color = "black", background = "darkgrey") %>%
    scroll_box(width = "100%", height = "500px")
}

# Função para substituir valores 
substituirNome <- function(df){
  for (i in 1:dim(df)[1]){
    df[i, -1][!is.na(df[i, -1])] <- "1"
    #df[i,-1][is.na(df[i,-1])] <- "0"
  }
  return(df)
}

simple_table <- function(data){
    kable(x = data, format="html", escape = F, align = "c") %>% 
    kable_styling(bootstrap_options ="striped") %>%
    row_spec(0,
             bold = T,
             color = "black",
             background = "darkgrey") %>%
    scroll_box(width = "100%")
}
```


# Carregamento das bases de dados

- Obter dados via Connectionstring do Access
 
```{r}
# Connectionstring do Access
cs_access <- "Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ= G:/Meu Drive/Dados_R/CASE_AGIBANK/compras.mdb"
# Mapeia conexÃ£o
con <- DBI::dbConnect(drv = odbc::odbc(),
                      .connection_string = cs_access,
                      encoding ="ISO-8859-1")
# Lista tabelas no banco
DBI::dbListTables(con)
```

1. itemtransacao

```{r}
# Obtendo dados da base sem criterios
df_itemtransacao <- dplyr::tbl(con, "itemtransacao")
# Mostra consulta em SQL
#df_itemtransacao <- dplyr::show_query(df_itemtransacao)

# Converte dados em tibbla
df_itemtransacao <- dplyr::as_tibble(df_itemtransacao)
```

2. itens

```{r}
# Obtendo dados da base sem criterios
df_itens <- dplyr::tbl(con, "itens")
# Mostra consulta em SQL
# df_itens <- dplyr::show_query(df_itens)

# Converte dados em tibbla
df_itens <- dplyr::as_tibble(df_itens)
```

3. transacoes

```{r}
# Obtendo dados da base sem criterios
df_transacoes <- dplyr::tbl(con, "transacoes")
# Mostra consulta em SQL
# df_transacoes <- dplyr::show_query(df_transacoes)

# Converte dados em tibbla
df_transacoes <- dplyr::as_tibble(df_transacoes)
```

```{r}
# Encerra a conexão e fecha o banco
odbc::dbDisconnect(con)
```

# Examinar os conjuntos de dados

## Data frame "df_itens"

- Este data frame contem os códigos dos itens e suas respectivas descrições. 
     
```{r}
head(df_itens,n=10)
names(df_itens)[colnames(df_itens) == "descrição"] <- "descricao"
```

```{r}
unique(df_itens$codItem)

unique(df_itens$descricao) 

unique(df_itens$marca)
df_itens$marca[df_itens$marca == "limão"] <- "limao"

unique(df_itens$tipo)
df_itens$tipo[df_itens$tipo == "refirgerante"] <- "refrigerante"
```

```{r}
# Exibir resumo 
my_summary(df_itens)
```

## Data frame "df_transacoes"

- Este data frame contém o identificador de cada transação, com seu respectivo valor e forma de pagamento.

```{r}
head(df_transacoes)
colnames(df_transacoes) <- c("IDTransacao","valorTotal","tipoPagamento")
```

```{r}
# Exibir resumo
my_summary(df_transacoes)
```

```{r}
unique(df_transacoes$IDTransacao) %>% length()  # não existe informação da transação 13

summary(df_transacoes$valorTotal)

ggplot(data = as.data.frame(table(df_transacoes$tipoPagamento))) +
  geom_col(aes(x=Var1,y=Freq), color = "grey28", fill = "grey68") +
  labs(x= "Forma de pagamento",y= "Frequência",title = "Frequência por tipo de pagamento")  +
  theme_classic() + theme(plot.title = element_text(hjust = 0.5)) +
  geom_text(aes(x=Var1,y=Freq,label=Freq),vjust = -0.5) +
  scale_y_continuous(limits = c(0,20))
```

## Data frame "df_itemtransacao" 

- Neste conjunto de dados foi mostrado o identificador de cada transação e os respectivos itens incluídos em cada uma delas.

```{r}
head(df_itemtransacao)
colnames(df_itemtransacao) <- c("IDTransacao","item")
```

```{r, comment=""}
my_summary(df_itemtransacao)
```

```{r}
ggplot(data = as.data.frame(table(df_itemtransacao$item))) +
  geom_col(aes(x=Var1,y=Freq), color = "grey28", fill = "grey68") +
  labs(x= "Item",y= "Quantidade",title = "Quantidade vendida de cada item")  +
  theme_classic() + theme(plot.title = element_text(hjust = 0.5))   +
  scale_y_continuous(limits = c(0,15)) + coord_flip()

ggplot(data = as.data.frame(table(df_itemtransacao$IDTransacao))) +
  geom_col(aes(x=Var1,y=Freq), color = "grey28", fill = "grey68") +
  labs(x= "IDTransação",y= "Quantidade",title = "Quantidade de itens em cada transação")  +
  theme_classic() + theme(plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0,8))
```

# União das bases de dados 

## Unir data frame "df_itemtransacao" com o data frame "df_itens"

```{r, comment=""}
df_TransItem <- left_join(df_itemtransacao,df_itens,by = c("item" = "codItem")) %>% group_by()
```

## Unir data frame "df_TransItem" com o data frame "df_transacoes" 

```{r, comment=""}
df_TransItemFull <- left_join(df_TransItem,df_transacoes,by = c("IDTransacao"))  %>% group_by(IDTransacao) %>% arrange(IDTransacao,item,.by_group = T)

head(df_TransItemFull,10)
```


# Análise dos dados após a união

## Análise do valor por transações

```{r, comment=""}
resumo_Transacao <- df_TransItemFull %>% 
  group_by(IDTransacao) %>% 
  summarise(count = n(),valorTransacao = sum(valorTotal)/count) %>% 
  mutate(perc_valorTransacao = (valorTransacao/sum(valorTransacao))*100,
         perc_lab = paste0(round(perc_valorTransacao,1),"%"))
```

```{r}
resumo_Transacao$IDTransacao <- as.factor(resumo_Transacao$IDTransacao)

ggplot(data = resumo_Transacao) +
  geom_col(aes(x = IDTransacao,y = valorTransacao), color = "grey28", fill = "grey68") +
  labs(x = "Transação" , y = "Valor", title =  "Valor de cada transação") +
  scale_fill_discrete("") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y = element_text(angle = 90, size = 12, vjust = 0.5),
        axis.title.x = element_text(size = 12),
        axis.text.y = element_text(size = 10,colour = "black"), 
        axis.text.x = element_text(size = 10,colour = "black"))  +
  scale_y_continuous(limits = c(0,35)) +
  geom_text(aes(x=IDTransacao,y=valorTransacao,label=perc_lab),size =2.6, vjust=-0.5,hjust=0.5)

ggplot(data = resumo_Transacao) +
  geom_col(aes(x = IDTransacao, y = perc_valorTransacao), color = "grey28", fill = "grey68") +
  labs(x = "Transação", y = "Percentual", title =  "Valor percentual de cada transação") +
  scale_fill_discrete("") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y = element_text(angle = 90, size = 12, vjust = 0.5),
        axis.title.x = element_text(size = 12),
        axis.text.y = element_text(size = 10,colour = "black"), 
        axis.text.x = element_text(size = 10,colour = "black"))  +
  scale_y_continuous(limits = c(0,15),labels = scales::percent_format(scale = 1,accuracy =5L))
```

## Análise por produto

```{r, comment=""}
resumo_Produto <- df_TransItemFull %>% 
  group_by(descricao) %>% 
  summarise(count = n()) %>% 
  mutate(perc_Produto = round((count/sum(count))*100,2),
         perc_label =  paste0(perc_Produto,"%")) 
```

```{r}
resumo_Produto$descricao <- as.factor(resumo_Produto$descricao)

ggplot(data = resumo_Produto) +
  geom_col(aes(x = count,y = descricao), color = "grey28", fill = "grey68") +
  labs(x = "Quantidade", y = "Produto", title =  "Quantidade vendida de cada produto") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y = element_text(angle = 90, size = 12, vjust = 0.5),
        axis.title.x = element_text(size = 12),
        axis.text.y = element_text(size = 10,colour = "black"), 
        axis.text.x = element_text(size = 10,colour = "black")) + 
  scale_x_continuous(limits = c(0,20)) +
  geom_text(aes(x = count,y = descricao,label = perc_label), vjust=0.5,hjust=-0.5)
```

## Análise por marca 

```{r, comment=""}
resumo_Marca <- df_TransItemFull %>% 
  group_by(marca) %>% 
  summarise(count = n()) %>% 
  mutate(perc_marca = round((count/sum(count))*100,2),
         perc_label =  paste0(perc_marca,"%")) 
```

```{r}
resumo_Marca$marca <- as.factor(resumo_Marca$marca)

ggplot(data = resumo_Marca) +
  geom_col(aes(x = count,y = marca), color = "grey28", fill = "grey68") +
  labs(x = "Quantidade", y = "Marca", title =  "Quantidade vendida de cada marca") +
  scale_fill_discrete("") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y = element_text(angle = 90, size = 12, vjust = 0.5),
        axis.title.x = element_text(size = 12),
        axis.text.y = element_text(size = 10,colour = "black"), 
        axis.text.x = element_text(size = 10,colour = "black")) + 
  scale_x_continuous(limits = c(0,30)) +
  geom_text(aes(x = count,y = marca,label = perc_label), vjust=0.5,hjust=-0.5)
```

## Análise por tipo

```{r, comment=""}
resumo_Tipo <- df_TransItemFull %>% 
  group_by(tipo) %>% 
  summarise(count = n()) %>% 
  mutate(perc_tipo = round((count/sum(count))*100,2),
         perc_label =  paste0(perc_tipo,"%")) 
```

```{r}
resumo_Tipo$tipo <- as.factor(resumo_Tipo$tipo)

ggplot(data = resumo_Tipo) +
  geom_col(aes(x = count,y = tipo), color = "grey28", fill = "grey68") +
  labs(x = "Quantidade", y = "Tipo", title =  "Quantidade vendida de cada tipo de produto") +
  scale_fill_discrete("") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y = element_text(angle = 90, size = 12, vjust = 0.5),
        axis.title.x = element_text(size = 12),
        axis.text.y = element_text(size = 10,colour = "black"), 
        axis.text.x = element_text(size = 10,colour = "black"))  +
  scale_x_continuous(limits = c(0,50)) +
  geom_text(aes(x = count,y = tipo,label = perc_label), vjust=0.5,hjust=-0.5)
```

## Resumo por tipo de pagamento

```{r, comment=""}
resumo_TipoPG <- df_TransItemFull %>% 
  group_by(tipoPagamento) %>% 
  summarise(count = n()) %>% 
  mutate(perc_tipoPG = round((count/sum(count))*100,2),
         perc_label =  paste0(perc_tipoPG,"%")) 
```

```{r}
resumo_TipoPG$tipoPagamento <- as.factor(resumo_TipoPG$tipoPagamento)

ggplot(data = resumo_TipoPG) +
  geom_col(aes(x = tipoPagamento,y = count), color = "grey28", fill = "grey68") +
  labs(x = "Tipo de pagamento" , y = "Quantidade", title =  "Quantidade por tipo de pagamento") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y = element_text(angle = 90, size = 12, vjust = 0.5),
        axis.title.x = element_text(size = 12),
        axis.text.y = element_text(size = 10,colour = "black"), 
        axis.text.x = element_text(size = 10,colour = "black"))  +
  scale_y_continuous(limits = c(0,60))  +
  geom_text(aes(x = tipoPagamento,y = count,label = perc_label), vjust=0.5,hjust=-0.5) +
  coord_flip()
```


# Gerar regras de associação 

## Regras de associação para produtos

```{r, error = TRUE, comment="",, warning = FALSE}
# Modelar e tratar tabela de associação de produtos e executar função "apriori"
associarProduto <- df_TransItemFull[,c(1,3)] %>% dcast(IDTransacao ~ descricao, value.var = "descricao")
associarProduto1 <- substituirNome(associarProduto)

# Gerar regras deassociação
regrasProduto <- apriori(data = associarProduto1[,-1], parameter = list(support = 0.1, confidence = 0.7));regrasProduto

r <- inspect(sort(regrasProduto, by = 'lift'))
regras <- data.frame(SE = r$lhs, ENTAO = r$rhs, 
                     Suporte = paste0(round(r$support*100,2),"%"), 
                     Confianca = paste0(round(r$confidence*100,2),"%"), 
                     Lift = r$lift); regras
```

## Regras de associação de marcas

```{r, error = TRUE, comment="", warning = FALSE}
# Tratar tabela de associação de marcas para executar algoritmo "apriori"
associarMarca <- df_TransItemFull[,c(1,4)] %>% distinct() %>% spread(key = marca, value = marca)
associarMarca1 <- substituirNome(associarMarca)

# Gerar regras deassociação
regrasMarca <- apriori(data = associarMarca1[,-1], parameter = list(support = 0.30, confidence = 0.80))

r <- inspect(sort(regrasMarca, by = 'lift'))
regras <- data.frame(SE = r$lhs, ENTAO = r$rhs, 
                     Suporte = paste0(round(r$support*100,2),"%"), 
                     Confianca = paste0(round(r$confidence*100,2),"%"), 
                     Lift = r$lift); regras
```

